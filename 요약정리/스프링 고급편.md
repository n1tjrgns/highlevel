## 스프링 핵심 원리 - 고급편

----

V3 버전에서 FieldLogTrace를 싱글톤으로 등록하여 작성했다.

하지만 여기서 1초안에 여러번의 호출이 들어왔을 때 꼬이게된다.

- 동시성 문제  : 여러 쓰레드가 동시에 같은 인스턴스의 필드 값을 변경하면서 발생하는 문제

  여러 쓰레드가 같은 인스턴스의 필드에 접근해야 하기 때문에, 싱글톤 객체의 필드를 변경해서 사용할 때는 이런 동시성 문제를 조심해야한다.

```
FieldLogTrace.traceIdHolder를 여러 쓰레드가 동시에 접근하기 떄문에 문제가 발생한다.
```



#### TIP

```
동시성 문제는 지역 변수에서는 발생하지 않는다. 지역 변수는 쓰레드마다 각각 다른 메모리 영역이 할당된다.
동시성 문제가 발생하는 곳은 인스턴스의 필드(주로 싱글톤), 또는 static 공용 필드 접근시 발생한다.
동시성 문제는 값을 읽기만 하면 발생하지 않는다. 어디선가 값을 변경하기 때문에 발생한다.
```

싱글톤 객체의 필드를 사용하면서 동시성 문제를 해결하려면??

- **스레드 로컬**



## 쓰레드 로컬

해당 쓰레드만 접글할 수 있는 저장소.

사용법

- .set
- .get
- .remove

> 사용을 완료하면 ThreadLocal.remove()를 호출해 쓰레드 로컬에서 저장된 값을 제거해줘야한다.!!



#### 주의사항

쓰레드 로컬의 값을 사용 후 제거하지 않고 그냥 두면 WAS 처럼 쓰레드 풀을 사용하는 경우 심각한 문제가 발생할 수 있다.

쓰레드 풀은 기존의 쓰레드를 삭제하지 않기 때문에 남아있는 데이터가 다른 호출시에 사용되어 다른데이터가 보이게 되는 심각한 문제가 발생할 수 있다.

----

## 리플렉션

리플렉션을 사용하면 클래스나 메소드의 메타정보를 동적으로 획득하고 코드도 동적으로 호출할 수 있다. 또한 JDK 동적 프록시를 이해하기 위해서는 리플렉션에 대한 이해가 필요하다.

